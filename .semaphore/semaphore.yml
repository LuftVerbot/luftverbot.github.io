version: v1.0
name: Update Data
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Install Dependencies
    task:
      prologue:
        commands:
          - checkout
          - cache restore nvm-cache-$(checksum .nvmrc) .nvm
          - cache restore node-modules-$(checksum package-lock.json) node_modules
      jobs:
        - name: Install Node.js and dependencies
          commands:
            - 'if [ ! -d "$HOME/.nvm" ]; then curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash; fi'
            - export NVM_DIR="$HOME/.nvm"
            - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
            - nvm install 14
            - nvm use 14
            - npm ci
      epilogue:
        always:
          commands:
            - cache store nvm-cache-$(checksum .nvmrc) .nvm
            - cache store node-modules-$(checksum package-lock.json) node_modules
  - name: Update Data
    task:
      prologue:
        commands:
          - checkout
          - cache restore nvm-cache-$(checksum .nvmrc) .nvm
          - cache restore node-modules-$(checksum package-lock.json) node_modules
      jobs:
        - name: Run Data Fetch Script
          commands:
            - export NVM_DIR="$HOME/.nvm"
            - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
            - nvm install 14
            - nvm use 14
            - npm install
            - node fetch_data.mjs
  - name: Commit and Push Changes
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Configure Git and Commit Changes
          commands:
            - git add data.json package-lock.json
            - git diff --cached --exit-code || git commit -m "Update data.json"
            - git push
      secrets:
        - name: SEMAPHORE_GITHUB_TOKEN
        - name: SEMAPHORE_PROJECT_REPONAME
        - name: SEMAPHORE_PROJECT_USERNAME
